<!DOCTYPE html>
<html lang="bn">
  <head>
    <script>
      document.addEventListener("contextmenu", (event) =>
        event.preventDefault()
      );
      document.addEventListener("keydown", (event) => {
        if (
          (event.ctrlKey &&
            ["u", "s", "i", "j"].includes(event.key.toLowerCase())) ||
          event.key === "F12"
        ) {
          event.preventDefault();
        }
      });
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Online Exam</title>
    <!-- Chart.js CDN -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap");

      body {
        font-family: "Hind Siliguri", sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        font-family: "Hind Siliguri", sans-serif;
        width: 100%;
        margin: auto;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        min-height: 80vh;
      }

      .exam-content {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #1b0b54;
        text-align: center;
        margin-bottom: 10px;
      }

      #timer {
        font-size: 20px;
        color: #1b0b54;
        margin-bottom: 5px;
        font-weight: normal;
        text-align: center;
      }

      #exam-info {
        font-size: 16px;
        color: black;
        margin-bottom: 20px;
        text-align: center;
      }

      #exam {
        width: 100%;
        min-height: 100px;
      }

      .chart-container {
        width: 200px;
        height: 200px;
        margin: 10px auto;
        background-color: #f9f9f9;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: none;
        padding: 10px;
      }

      .chart-container.visible {
        display: block;
      }

      .question-container {
        text-align: left;
        margin-bottom: 20px;
        display: block;
      }

      .question-label {
        font-weight: bold;
        color: #1b0b54;
        margin-bottom: 10px;
      }

      .options {
        margin-top: 10px;
      }

      .option {
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
        text-transform: uppercase;
      }

      .circle {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid #1b0b54;
        margin-right: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        color: #1b0b54;
        font-weight: bold;
        font-size: 18px;
      }

      .selected .circle {
        background-color: #1b0b54;
        color: white;
      }

      .correct-text {
        color: green !important;
      }

      .incorrect-text {
        color: #ff0800 !important;
      }

      .unattempted-text {
        color: orange !important;
      }

      #submitBtn {
        font-family: hind siliguri;
        padding: 15px 30px;
        background-color: #1b0b54;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 18px;
        font-weight: bold;
        border-radius: 10px;
        margin-top: 20px;
        width: 200px;
        transition: background-color 0.3s ease;
      }

      #submitBtn:hover {
        background-color: #1b0b54;
      }

      .popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        width: 300px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        text-align: center;
        display: none;
        z-index: 1000;
        transition: transform 0.5s ease, opacity 0.5s ease;
      }

      .popup.slide-out {
        transform: translate(-50%, -100%);
        opacity: 0;
      }

      .popup-header {
        background-color: #1b0b54;
        color: white;
        padding: 10px;
        font-size: 20px;
        font-weight: bold;
        border-radius: 10px 10px 0 0;
      }

      .popup-body {
        padding: 15px;
      }

      .popup-body p {
        margin: 10px 0;
      }

      .confirm-btn {
        font-family: hind siliguri;
        background-color: #34c759;
        color: white;
        padding: 8px 15px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        margin: 5px;
      }

      .confirm-btn:hover {
        background-color: #34c759;
      }

      .cancel-btn {
        background-color: #ff3b30;
        color: white;
        padding: 8px 15px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        border-radius: 5px;
        margin: 5px;
      }

      .cancel-btn:hover {
        background-color: #e02b21;
      }

      .explanation-dropdown {
        display: none;
        margin-top: 10px;
      }

      .explanation-dropdown.visible {
        display: block;
      }

      .explanation-btn {
        background-color: #1b0b54;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-family: "Hind Siliguri", sans-serif;
        width: 40%;
        text-align: left;
        position: relative;
      }

      .explanation-btn:hover {
        background-color: #1b0b54;
      }

      .explanation-btn::after {
        content: "▼";
        position: absolute;
        right: 10px;
        font-size: 12px;
      }

      .explanation-btn.active::after {
        content: "▲";
      }

      .explanation-content {
        display: none;
        padding: 15px;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 14px;
        color: #000000;
        text-align: left;
        max-height: 450px;
        overflow-y: auto;
        margin-top: 5px;
      }

      .explanation-content.visible {
        display: block;
      }

      .explanation-content p {
        margin: 0 0 10px 0;
      }

      .explanation-content ul {
        margin: 0;
        padding-left: 20px;
      }

      .explanation-content li {
        margin-bottom: 5px;
      }

      .explanation-content strong {
        color: #1b0b54;
      }

      .explanation-label {
        font-weight: bold;
        color: #1b0b54;
        margin-bottom: 10px;
        display: block;
      }

      .locked .option {
        pointer-events: none;
        cursor: default;
      }

      .locked .option.selected {
        pointer-events: none;
        cursor: default;
      }
    </style>
  </head>

  <body>
    <div class="container" id="examContainer">
      <div class="exam-content">
        <h1>ইংরেজী অনুশীলন</h1>
        <div id="timer"></div>
        <div id="exam-info"></div>
        <div class="chart-container">
          <canvas id="scoreChart"></canvas>
        </div>
        <div id="exam">
          <!-- Questions will be generated dynamically -->
        </div>
        <button id="submitBtn">সাবমিট</button>
      </div>
    </div>

    <div class="popup" id="scorePopup">
      <div class="popup-header">তোমার স্কোর</div>
      <div class="popup-body">
        <p><strong>মোট প্রশ্ন:</strong> <span id="totalQuestions"></span></p>
        <p>
          <strong>উত্তর দিয়েছো:</strong>
          <span style="color: #000000" id="answered"></span>
        </p>
        <p>
          <strong>সঠিক উত্তর:</strong>
          <span style="color: #0ab853" id="correctAnswers"></span>
        </p>
        <p>
          <strong>ভুল উত্তর:</strong>
          <span style="color: #f81010" id="wrongAnswers"></span>
        </p>
        <p>
          <strong>অনুত্তরিত:</strong>
          <span style="color: #ffc801" id="unanswered"></span>
        </p>
        <p><strong>তোমার চূড়ান্ত স্কোর:</strong></p>
        <h2 style="color: #1b0b54"><span id="finalScore"></span></h2>
        <form id="scoreForm" action="https://formspree.io/f/xpby" method="POST">
          <input type="hidden" name="userID" id="formUserID" />
          <input type="hidden" name="finalScore" id="formFinalScore" />
          <input type="hidden" name="correctAnswers" id="formCorrectAnswers" />
          <input type="hidden" name="wrongAnswers" id="formWrongAnswers" />
          <input type="hidden" name="unanswered" id="formUnanswered" />
          <button
            type="submit"
            class="confirm-btn"
            style="background-color: #1b0b54"
          >
            <b>ওকে</b>
          </button>
        </form>
      </div>
    </div>

    <div class="popup" id="confirmPopup">
      <div class="popup-header">কনফার্ম করো</div>
      <div class="popup-body">
        <p>
          ভালো করে দেখে নাও! <br />
          পরীক্ষা শেষ করতে চাও তো?
        </p>
        <button class="confirm-btn" onclick="confirmSubmit()">
          <b>হ্যাঁ</b>
        </button>
        <button class="cancel-btn" onclick="cancelSubmit()"><b>না</b></button>
      </div>
    </div>

    <script>
      let chartInstance = null;

      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM fully loaded and parsed");
        const examContainer = document.getElementById("examContainer");
        if (!examContainer) {
          console.error("Exam container not found!");
          return;
        }
        try {
          sessionStorage.setItem("isLoggedIn", "true");
          sessionStorage.setItem("userID", "anonymous");
          console.log(
            "Session storage set: isLoggedIn = true, userID = anonymous"
          );
        } catch (e) {
          console.error("Session storage error:", e);
        }
        examContainer.style.display = "block";
        console.log("Exam container displayed");
        startTimer();
        generateQuestions();

        window.addEventListener("beforeunload", function (event) {
          if (
            examContainer.style.display === "block" &&
            sessionStorage.getItem("isLoggedIn") === "true"
          ) {
            autoSubmitScore();
          }
        });
      });

      const questions = [
        {
          id: 1,
          question: "I like _ the kitchen as often as possible.",
          options: {
            a: "clean",
            b: "cleaning",
            c: "that I clean",
            d: "to clean",
          },
          correct: "d",
          explanation:
            "The verb 'like' can be followed by either a gerund (V-ing) or an infinitive (to + V) with little difference in meaning. However, 'to clean' is often preferred for general preferences and habitual actions like this. Both (b) and (d) are grammatically possible, but 'to clean' (infinitive) is a very common and natural fit here to express a general preference.",
        },
        {
          id: 2,
          question: "Choose the correct sentence:",
          options: {
            a: "He discussed the matter.",
            b: "He discussed about the matter.",
            c: "He discussed on the matter.",
            d: "None of the above.",
          },
          correct: "a",
          explanation:
            "The verb 'discuss' is a transitive verb, meaning it directly takes an object without a preposition. So, 'discuss the matter' is the correct usage. Options (b) and (c) incorrectly use prepositions 'about' and 'on' after 'discuss'.",
        },
        {
          id: 3,
          question:
            "Fill in the blank with the correct word. _ he lay on the ground groaning.",
          options: {
            a: "Injured",
            b: "Injuring",
            c: "Having injured",
            d: "Be injured",
          },
          correct: "a",
          explanation:
            "This sentence uses a past participle ('Injured') at the beginning to describe the state of the subject ('he'). It implies 'Being injured, he lay...' or 'Because he was injured, he lay...'. 'Injured' acts as an adjective here, describing 'he'.",
        },
        {
          id: 4,
          question:
            "Choose the correct sentence according to the structure: sub + linking verb + noun complement.",
          options: {
            a: "They are students.",
            b: "He reads loudly.",
            c: "The scheme proved lucrative.",
            d: "They are students.",
          },
          correct: "a",
          explanation:
            "A linking verb connects the subject to a noun (noun complement) or an adjective (adjective complement) that renames or describes the subject. In (a), 'They' (subject) + 'are' (linking verb) + 'students' (noun complement, renaming 'They'). (b) has an adverb, (c) has an adjective complement, and (d) is a repeat of (a).",
        },
        {
          id: 5,
          question:
            "The debutante could not _ the pressure of playing in an international match.",
          options: {
            a: "cope",
            b: "cope up with",
            c: "cope with",
            d: "cope",
          },
          correct: "c",
          explanation:
            "The correct idiom is 'cope with' something, meaning to deal effectively with something difficult. 'Cope up with' is a common error.",
        },
        {
          id: 6,
          question:
            "What type of verb is the underlined word: I _play_ football?",
          options: {
            a: "Finite",
            b: "Nonfinite",
            c: "Transitive",
            d: "Intransitive",
          },
          correct: "a",
          explanation:
            "The underlined word is 'play'. A finite verb changes its form according to the tense, number, and person of the subject. Here, 'play' is the main verb of the sentence, conjugated for the first person singular in the present simple tense. It also happens to be a transitive verb because it has a direct object ('football'), but 'Finite' describes its primary grammatical characteristic as the main verb.",
        },
        {
          id: 7,
          question: "\"I will not let you go.\" In this sentence 'go' is a/an-",
          options: {
            a: "infinitive",
            b: "gerund",
            c: "participle",
            d: "verbal noun",
          },
          correct: "a",
          explanation:
            "After the verb 'let', the base form of a verb is used without 'to'. This construction is known as a bare infinitive. So, 'go' here is an infinitive.",
        },
        {
          id: 8,
          question:
            "\"Huffing and puffing, we arrived at the classroom door with only seven seconds to spare.\" In this sentence the verb 'arrived' is-",
          options: {
            a: "intransitive",
            b: "transitive",
            c: "causative",
            d: "defective",
          },
          correct: "a",
          explanation:
            "An intransitive verb does not take a direct object. In this sentence, 'arrived' does not have a direct object; it describes the action of the subject 'we'. The phrase 'at the classroom door' is a prepositional phrase indicating location, not a direct object.",
        },
        {
          id: 9,
          question: "In the 18th Century, the Mughal Empire began to _ .",
          options: {
            a: "discriminate",
            b: "disintegrate",
            c: "differentiate",
            d: "dislocate",
          },
          correct: "b",
          explanation:
            "The phrase 'began to' suggests a process of decline or breaking apart for an empire. 'Disintegrate' means to break up into small parts as a result of impact or decay; to collapse or break down. This fits the historical context of the Mughal Empire's decline.",
        },
        {
          id: 10,
          question:
            "I took a map with me, as I didn’t want to _ my way on the journey.",
          options: {
            a: "loose",
            b: "lose",
            c: "lost",
            d: "loss",
          },
          correct: "b",
          explanation:
            "'Lose' (verb) means to be unable to find something or to misplace. 'Loose' (adjective/verb) means not firmly fixed. 'Lost' is the past tense of 'lose'. 'Loss' is a noun. The correct verb to express misplacing one's way is 'lose'.",
        },
        {
          id: 11,
          question: "He advised me _ smoking.",
          options: {
            a: "giving up",
            b: "to give up",
            c: "in giving up",
            d: "from giving up",
          },
          correct: "b",
          explanation:
            "The verb 'advise' is typically followed by an object pronoun and then an infinitive (to + verb). So, 'advised me to give up' is the correct construction.",
        },
        {
          id: 12,
          question:
            'Choose the correct one to fill in the blank, "I came to England _ English".',
          options: {
            a: "to learn",
            b: "for to learn",
            c: "to learning",
            d: "for learning",
          },
          correct: "a",
          explanation:
            "To express the purpose of an action, we usually use an infinitive (to + verb). 'To learn' clearly states the purpose of coming to England.",
        },
        {
          id: 13,
          question:
            "You should _dress_ for cold weather today. The underlined word is a-",
          options: {
            a: "Conjunction",
            b: "Preposition",
            c: "Verb",
            d: "Noun",
          },
          correct: "c",
          explanation:
            "The underlined word is 'dress'. It is an action word indicating what one should do (put on clothes). It follows the modal verb 'should', confirming its function as a verb.",
        },
        {
          id: 14,
          question:
            "I loved to play chess when I was at college. Here 'to play' is a/an -",
          options: {
            a: "participle",
            b: "noun",
            c: "gerund",
            d: "infinitive",
          },
          correct: "d",
          explanation:
            "'To play' is the base form of the verb preceded by 'to', which is the definition of an infinitive.",
        },
        {
          id: 15,
          question: "He became a politician. Here 'became' is a/an _",
          options: {
            a: "Transitive verb",
            b: "Linking verb",
            c: "Action verb",
            d: "Intransitive verb",
          },
          correct: "b",
          explanation:
            "A linking verb connects the subject to a noun (politician) that renames or identifies the subject (He). 'Became' does not show action but rather a state of being or a change in state. It connects 'He' to 'politician'.",
        },
        {
          id: 16,
          question: "A friend of mine phoned _ me to a party.",
          options: {
            a: "for invite",
            b: "to invite",
            c: "for inviting",
            d: "for to invite",
          },
          correct: "b",
          explanation:
            "To express the purpose of an action (why the friend phoned), an infinitive (to + verb) is used. So, 'to invite' is the correct choice.",
        },
        {
          id: 17,
          question: "Which of the following words is a verb?",
          options: {
            a: "Rectitude",
            b: "Retch",
            c: "Retardant",
            d: "Reconnoiter",
          },
          correct: "b, d",
          explanation:
            "'Rectitude' is a noun. 'Retch' is a verb meaning to make an effort to vomit. 'Retardant' is a noun or adjective. 'Reconnoiter' is a verb meaning to make a military observation of (a region) to locate an enemy or ascertain strategic features.",
        },
        {
          id: 18,
          question: "My doctor had absolutely forbidden me _ champagne.",
          options: {
            a: "to not to drink",
            b: "to drink",
            c: "drinking",
            d: "for drinking of",
          },
          correct: "c",
          explanation:
            "The verb 'forbid' can be followed by an object and then a gerund (V-ing) when talking about prohibiting an activity. 'Forbidden me drinking' is the correct and natural construction here.",
        },
        {
          id: 19,
          question: 'Honey tastes sweet. Here "tastes" is an example of-',
          options: {
            a: "Factitive verb",
            b: "Perception verb",
            c: "Causative verb",
            d: "Quasi-passive verb",
          },
          correct: "b",
          explanation:
            "Verbs like 'taste', 'smell', 'sound', 'feel', and 'look' are often called verbs of perception or sensation. They link the subject to an adjective that describes a quality perceived through the senses.",
        },
        {
          id: 20,
          question: "_ Roma _ ill since last week.",
          options: {
            a: "had been",
            b: "is",
            c: "has been",
            d: "was",
          },
          correct: "c",
          explanation:
            "The phrase 'since last week' indicates an action or state that started in the past and continues up to the present. This requires the present perfect continuous tense (or present perfect simple for states), so 'has been' is appropriate here. 'Roma has been ill since last week'.",
        },
        {
          id: 21,
          question: "The number of auxiliary verbs in English is-",
          options: {
            a: "twelve",
            b: "fifteen",
            c: "eleven",
            d: "thirteen",
          },
          correct: "d",
          explanation:
            "The primary auxiliary verbs are 'be' (am, is, are, was, were, been, being), 'do' (do, does, did), and 'have' (has, have, had). This makes 3 main types, with various forms. Additionally, there are 10 modal auxiliary verbs: can, could, may, might, must, shall, should, will, would, ought to. If we count 'ought to' as one, the total number of distinct auxiliary verbs (primary and modal) is 3 (be, do, have) + 10 (modals) = 13.",
        },
        {
          id: 22,
          question: "Fire burns. What kind of verb is 'burn'?",
          options: {
            a: "causative",
            b: "copulative",
            c: "intransitive",
            d: "transitive",
          },
          correct: "c",
          explanation:
            "In this sentence, 'burns' does not take a direct object (fire itself is doing the burning without affecting something else). It describes an action performed by the subject alone. Therefore, it is an intransitive verb.",
        },
        {
          id: 23,
          question: "Which one of the following is a causative verb?",
          options: {
            a: "do",
            b: "happen",
            c: "help",
            d: "cause",
          },
          correct: "d",
          explanation:
            "Causative verbs are used to show that someone or something makes something else happen. 'Cause' directly means to make something happen, making it a causative verb. Other common causative verbs include 'make', 'have', 'let', 'get', 'help'.",
        },
        {
          id: 24,
          question:
            "Which of the following can be used as a 'modal' as well as 'main' verb?",
          options: {
            a: "do",
            b: "need",
            c: "could",
            d: "mind",
          },
          correct: "b",
          explanation:
            "'Need' can function as a modal verb (e.g., 'You needn't worry') and as a main verb (e.g., 'I need help'). 'Do' is a primary auxiliary/main verb, 'could' is only a modal, and 'mind' is a main verb.",
        },
        {
          id: 25,
          question: "Father loves me. Here 'loves' is an example of-",
          options: {
            a: "intransitive verb",
            b: "simple verb",
            c: "auxiliary verb",
            d: "transitive verb",
          },
          correct: "d",
          explanation:
            "A transitive verb is a verb that takes a direct object. In this sentence, 'loves' takes 'me' as its direct object (who does Father love? Me). Therefore, 'loves' is a transitive verb.",
        },
        {
          id: 26,
          question:
            "We want to take legal action against the hoodlum. In this sentence 'to' is a/an-",
          options: {
            a: "adverb",
            b: "conjunction",
            c: "preposition",
            d: "infinitive marker",
          },
          correct: "d",
          explanation:
            "In the phrase 'to take', 'to' precedes the base form of the verb 'take' to form an infinitive. It serves as an infinitive marker, not a preposition in this context (as it doesn't introduce a noun phrase).",
        },
      ];

      const totalQuestions = questions.length;
      let timeLeft = Math.floor(totalQuestions / 2) * 60;
      const timerElement = document.getElementById("timer");
      let timerInterval;

      function updateTimer() {
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerElement.innerText = `${toBengaliNumber(
          minutes
        )} মিনিট ${toBengaliNumber(seconds)} সেকেন্ড`;

        if (timeLeft > 0) {
          timeLeft--;
        } else {
          stopTimer();
          confirmSubmit();
        }
      }

      function startTimer() {
        console.log("Starting timer");
        timerElement.innerText = `${toBengaliNumber(
          Math.floor(timeLeft / 60)
        )} মিনিট ${toBengaliNumber(timeLeft % 60)} সেকেন্ড`;
        timerInterval = setInterval(updateTimer, 1000);
      }

      function stopTimer() {
        clearInterval(timerInterval);
        console.log("Timer stopped");
      }

      function toBengaliNumber(num) {
        const bengaliDigits = [
          "০",
          "১",
          "২",
          "৩",
          "৪",
          "৫",
          "৬",
          "৭",
          "৮",
          "৯",
        ];
        let numStr = num.toString();

        let isNegative = num < 0;
        if (isNegative) {
          numStr = numStr.substring(1);
        }

        if (numStr.includes(".")) {
          let [integerPart, decimalPart] = numStr.split(".");
          let integerBengali = integerPart
            .split("")
            .map((digit) => bengaliDigits[parseInt(digit)])
            .join("");
          let decimalBengali = decimalPart
            .split("")
            .map((digit) => bengaliDigits[parseInt(digit)])
            .join("");
          return (
            (isNegative ? "−" : "") + integerBengali + "." + decimalBengali
          );
        } else {
          let integerBengali = numStr
            .split("")
            .map((digit) => bengaliDigits[parseInt(digit)])
            .join("");
          return (isNegative ? "−" : "") + integerBengali;
        }
      }

      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function generateQuestions() {
        console.log("Generating questions");
        const examContainer = document.querySelector("#exam");
        if (!examContainer) {
          console.error("Exam container (#exam) not found!");
          return;
        }
        examContainer.innerHTML = "";
        console.log("Questions array:", questions);
        const shuffledQuestions = shuffleArray([...questions]);
        shuffledQuestions.forEach((question, index) => {
          console.log(`Generating question ${index + 1}:`, question);
          const questionDiv = document.createElement("div");
          questionDiv.classList.add("question-container");
          questionDiv.setAttribute("data-question", question.id);
          questionDiv.setAttribute("data-correct", question.correct);

          let optionsHTML = "";
          for (let option in question.options) {
            optionsHTML += `
                                                                          <label class="option" data-option="${option}">
                                                                            <div class="circle">${option}</div>
                                                                            <span class="option-text">${question.options[option]}</span>
                                                                          </label>
                                                                        `;
          }

          const explanationHTML = question.explanation
            ? `<div class="explanation-dropdown">
                                                                             <button class="explanation-btn">ব্যাখ্যা দেখো</button>
                                                                             <div class="explanation-content">
                                                                               <div class="explanation-label">ব্যাখ্যা:</div>
                                                                               ${question.explanation}
                                                                             </div>
                                                                           </div>`
            : "";

          questionDiv.innerHTML = `
                                                                        <p class="question-label">${
                                                                          index +
                                                                          1
                                                                        }. ${
            question.question
          }</p>
                                                                        <div class="options">
                                                                          ${optionsHTML}
                                                                        </div>
                                                                        ${explanationHTML}
                                                                      `;
          examContainer.appendChild(questionDiv);
          console.log(`Appended question ${index + 1} to exam container`);
        });

        const questionContainers = document.querySelectorAll(
          ".question-container"
        );
        console.log(`Found ${questionContainers.length} question containers`);
        questionContainers.forEach((container, idx) => {
          console.log(`Setting question ${idx + 1} to visible`);
          container.style.display = "block";
        });

        document.querySelectorAll(".option").forEach((option) => {
          option.addEventListener(
            "click",
            function (e) {
              e.preventDefault();
              const parent = this.closest(".question-container");
              if (parent.classList.contains("locked")) return;
              parent.classList.add("locked");
              parent.querySelectorAll(".option").forEach((el) => {
                if (el !== this) {
                  el.style.pointerEvents = "none";
                  el.style.cursor = "default";
                }
                el.classList.remove("selected");
              });
              this.classList.add("selected");
              console.log(
                `Option selected for question ${parent.getAttribute(
                  "data-question"
                )}: ${this.getAttribute("data-option")}`
              );
            },
            { once: true }
          );
        });

        document.querySelectorAll(".explanation-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const content = this.nextElementSibling;
            content.classList.toggle("visible");
            this.classList.toggle("active");
            console.log("Toggled explanation visibility");
          });
        });

        const examInfo = document.getElementById("exam-info");
        if (examInfo) {
          examInfo.innerText = `পূর্ণ নম্বরঃ ${toBengaliNumber(
            totalQuestions
          )}`;
          console.log("Exam info updated");
        } else {
          console.error("Exam info element not found!");
        }
      }

      function initializeChart() {
        console.log("Initializing chart");
        const ctx = document.getElementById("scoreChart").getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "pie",
          data: {
            labels: ["ঠিক উত্তর", "ভুল উত্তর", "অনুত্তরিত"],
            datasets: [
              {
                data: [0, 0, 0],
                backgroundColor: ["#34c759", "#ff3b30", "#007aff"],
                borderColor: "#fff",
                borderWidth: 2,
                hoverOffset: 10,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "10%",
            layout: {
              padding: 10,
            },
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  font: {
                    family: '"Hind Siliguri", sans-serif',
                    size: 13,
                    weight: "bold",
                  },
                  color: "#333",
                  padding: 12,
                  boxWidth: 14,
                  generateLabels: (chart) => {
                    const data = chart.data;
                    return data.labels.map((label, i) => ({
                      text: label,
                      font: {
                        family: '"Hind Siliguri", sans-serif',
                      },
                      fillStyle: data.datasets[0].backgroundColor[i],
                      hidden: !chart.getDataVisibility(i),
                      index: i,
                    }));
                  },
                },
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.9)",
                cornerRadius: 6,
                titleFont: {
                  family: '"Hind Siliguri", sans-serif',
                  size: 14,
                  weight: "bold",
                },
                bodyFont: {
                  family: '"Hind Siliguri", sans-serif',
                  size: 13,
                },
                padding: 10,
                boxPadding: 5,
              },
            },
            animation: {
              animateScale: true,
              animateRotate: true,
              duration: 1000,
              easing: "easeOutQuart",
            },
            elements: {
              arc: {
                borderRadius: 8,
              },
            },
            onClick: (e, elements) => {
              if (elements.length > 0) {
                const index = elements[0].index;
                const filter = ["correct", "wrong", "unanswered"][index];
                filterQuestions(filter);
              } else {
                filterQuestions("all");
              }
            },
          },
        });
        console.log("Chart initialized");
      }

      function filterQuestions(type) {
        console.log(`Filtering questions by type: ${type}`);
        document.querySelectorAll(".question-container").forEach((question) => {
          const status = question.getAttribute("data-status");
          if (type === "all" || status === type) {
            question.style.display = "block";
          } else {
            question.style.display = "none";
          }
        });
      }

      function showConfirmPopup() {
        console.log("Showing confirm popup");
        document.getElementById("confirmPopup").style.display = "block";
      }

      function autoSubmitScore() {
        console.log("Auto-submitting score");
        stopTimer();
        let score = 0,
          total = questions.length,
          answered = 0,
          correct = 0,
          wrong = 0,
          unanswered = 0;

        document.querySelectorAll(".question-container").forEach((question) => {
          let correctAnswer = question.getAttribute("data-correct");
          let selectedOption = question.querySelector(".option.selected");

          if (selectedOption) {
            answered++;
            let chosenAnswer = selectedOption.getAttribute("data-option");
            if (chosenAnswer === correctAnswer) {
              score += 1;
              correct++;
              question.setAttribute("data-status", "correct");
            } else {
              score -= 0.25;
              wrong++;
              question.setAttribute("data-status", "wrong");
            }
          } else {
            unanswered++;
            question.setAttribute("data-status", "unanswered");
          }
        });

        const userID = sessionStorage.getItem("userID") || "anonymous";
        const formData = new FormData();
        formData.append("userID", userID);
        formData.append("finalScore", score.toFixed(2));
        formData.append("correctAnswers", correct);
        formData.append("wrongAnswers", wrong);
        formData.append("unanswered", unanswered);

        const url = "https://formspree.io/f/xpwy";
        navigator.sendBeacon(url, formData);
        console.log("Auto-submission sent via sendBeacon for userID:", userID);
      }

      function confirmSubmit() {
        console.log("Confirming submission");
        document.getElementById("confirmPopup").style.display = "none";
        stopTimer();
        let score = 0,
          total = questions.length,
          answered = 0,
          correct = 0,
          wrong = 0,
          unanswered = 0;

        document
          .querySelectorAll(".question-container")
          .forEach((question, index) => {
            let correctAnswer = question.getAttribute("data-correct");
            let selectedOption = question.querySelector(".option.selected");

            if (selectedOption) {
              answered++;
              let chosenAnswer = selectedOption.getAttribute("data-option");
              if (chosenAnswer === correctAnswer) {
                selectedOption
                  .querySelector(".option-text")
                  .classList.add("correct-text");
                score += 1;
                correct++;
                question.setAttribute("data-status", "correct");
              } else {
                selectedOption
                  .querySelector(".option-text")
                  .classList.add("incorrect-text");
                question
                  .querySelector(
                    `[data-option="${correctAnswer}"] .option-text`
                  )
                  .classList.add("correct-text");
                score -= 0.25;
                wrong++;
                question.setAttribute("data-status", "wrong");
              }
            } else {
              question
                .querySelector(`[data-option="${correctAnswer}"] .option-text`)
                .classList.add("unattempted-text");
              unanswered++;
              question.setAttribute("data-status", "unanswered");
            }
            question.style.display = "block";

            const explanationDropdown = question.querySelector(
              ".explanation-dropdown"
            );
            if (explanationDropdown) {
              explanationDropdown.classList.add("visible");
            }
          });

        const chartContainer = document.querySelector(".chart-container");
        chartContainer.classList.add("visible");
        if (!chartInstance) {
          initializeChart();
        }
        chartInstance.data.datasets[0].data = [correct, wrong, unanswered];
        chartInstance.update();
        console.log("Chart updated with data:", [correct, wrong, unanswered]);

        const userID = sessionStorage.getItem("userID") || "anonymous";
        document.getElementById("totalQuestions").innerText =
          toBengaliNumber(total);
        document.getElementById("answered").innerText =
          toBengaliNumber(answered);
        document.getElementById("correctAnswers").innerText =
          toBengaliNumber(correct);
        document.getElementById("wrongAnswers").innerText =
          toBengaliNumber(wrong);
        document.getElementById("unanswered").innerText =
          toBengaliNumber(unanswered);
        document.getElementById("finalScore").innerText = toBengaliNumber(
          score.toFixed(2)
        );

        document.getElementById("formUserID").value = userID;
        document.getElementById("formFinalScore").value = score.toFixed(2);
        document.getElementById("formCorrectAnswers").value = correct;
        document.getElementById("formWrongAnswers").value = wrong;
        document.getElementById("formUnanswered").value = unanswered;

        document.getElementById("submitBtn").style.display = "none";

        document.getElementById("scorePopup").style.display = "block";

        const form = document.getElementById("scoreForm");
        fetch(form.action, {
          method: "POST",
          body: new FormData(form),
          headers: {
            Accept: "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              console.log("Form submitted successfully");
              form.reset();
            } else {
              console.error("Form submission failed:", response.statusText);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      function cancelSubmit() {
        console.log("Canceling submission");
        document.getElementById("confirmPopup").style.display = "none";
      }

      document
        .getElementById("submitBtn")
        .addEventListener("click", function () {
          console.log("Submit button clicked");
          showConfirmPopup();
        });

      function closePopup() {
        console.log("Closing score popup");
        const scorePopup = document.getElementById("scorePopup");
        scorePopup.classList.add("slide-out");
        setTimeout(() => {
          scorePopup.style.display = "none";
          scorePopup.classList.remove("slide-out");
          window.scrollTo({ top: 0, behavior: "smooth" });
        }, 500);
      }

      document
        .getElementById("scoreForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();
          console.log("Score form submitted");
          closePopup();
        });
    </script>
  </body>
</html>
